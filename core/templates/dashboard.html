{% extends 'base.html' %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">Dashboard</h2>
    <div>
      <span class="me-2">Welcome, <strong>{{ user.email }}</strong></span>
      <a href="{% url 'profile' %}" class="btn btn-outline-secondary btn-sm">Profile</a>
      <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm ms-2">Logout</a>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white">Your Accounts</div>
        <ul class="list-group list-group-flush">
          {% for account in accounts %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ account.name }} <span class="badge bg-light text-dark">{{ account.currency }}</span> <span class="ms-2">Balance: <strong>{{ account.balance }}</strong></span></span>
              <span>
                <a href="{% url 'account_edit' account.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                <a href="{% url 'account_delete' account.pk %}" class="btn btn-sm btn-outline-danger ms-1">Delete</a>
              </span>
            </li>
          {% empty %}
            <li class="list-group-item">No accounts yet.</li>
          {% endfor %}
        </ul>
        <div class="card-footer text-end">
          <a href="{% url 'account_create' %}" class="btn btn-success btn-sm">Add Account</a>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-success text-white">Summary</div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Total PnL:</strong> {{ total_pnl }}</li>
          <li class="list-group-item"><strong>Win Rate:</strong> {{ win_rate|floatformat:2 }}%</li>
          <li class="list-group-item"><strong>Avg. Risk/Reward:</strong> {{ avg_risk_reward|floatformat:2 }}</li>
        </ul>
        <div class="card-body">
          <canvas id="pnlChart" width="400" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <a href="{% url 'trade_create' %}" class="btn btn-primary btn-sm">Add Trade</a>
    <a href="{% url 'trade_import_csv' %}" class="btn btn-secondary btn-sm">Import Trades (CSV)</a>
    <a href="{% url 'trade_export_csv' %}" class="btn btn-secondary btn-sm">Export Trades (CSV)</a>
    <a href="{% url 'position_size_calculator' %}" class="btn btn-info btn-sm">Position Size Calculator</a>
    <a href="{% url 'fetch_mt5_trades' %}" class="btn btn-success btn-sm">Fetch MT5 Trades</a>
  </div>

  <form method="get" class="row g-2 mb-3 align-items-end">
    <div class="col-md-2">
      <input type="text" name="instrument" class="form-control" placeholder="Instrument" value="{{ filter.instrument }}">
    </div>
    <div class="col-md-2">
      <select name="outcome" class="form-select">
        <option value="">All Outcomes</option>
        <option value="win" {% if filter.outcome == 'win' %}selected{% endif %}>Win</option>
        <option value="loss" {% if filter.outcome == 'loss' %}selected{% endif %}>Loss</option>
      </select>
    </div>
    <div class="col-md-2">
      <input type="date" name="start_date" class="form-control" value="{{ filter.start_date }}">
    </div>
    <div class="col-md-2">
      <input type="date" name="end_date" class="form-control" value="{{ filter.end_date }}">
    </div>
    <div class="col-md-2">
      <select name="sort" class="form-select">
        <option value="exit_date" {% if filter.sort == 'exit_date' %}selected{% endif %}>Sort by Exit Date</option>
        <option value="entry_date" {% if filter.sort == 'entry_date' %}selected{% endif %}>Sort by Entry Date</option>
        <option value="instrument" {% if filter.sort == 'instrument' %}selected{% endif %}>Sort by Instrument</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">Your Trades</div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Instrument</th>
            <th>Entry Date</th>
            <th>Exit Date</th>
            <th>PnL</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for trade in trades %}
          <tr>
            <td>{{ trade.instrument }}</td>
            <td>{{ trade.entry_date|date:'Y-m-d H:i' }}</td>
            <td>{{ trade.exit_date|date:'Y-m-d H:i' }}</td>
            <td>{% if trade.pnl >= 0 %}<span class="text-success">{{ trade.pnl|floatformat:2 }}</span>{% else %}<span class="text-danger">{{ trade.pnl|floatformat:2 }}</span>{% endif %}</td>
            <td>
              <a href="{% url 'trade_edit' trade.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
              <a href="{% url 'trade_delete' trade.pk %}" class="btn btn-sm btn-outline-danger ms-1">Delete</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center">No trades yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card-footer">
      <nav aria-label="Trade pagination">
        <ul class="pagination justify-content-center mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?{% if filter.instrument %}instrument={{ filter.instrument }}&{% endif %}{% if filter.outcome %}outcome={{ filter.outcome }}&{% endif %}{% if filter.start_date %}start_date={{ filter.start_date }}&{% endif %}{% if filter.end_date %}end_date={{ filter.end_date }}&{% endif %}{% if filter.sort %}sort={{ filter.sort }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?{% if filter.instrument %}instrument={{ filter.instrument }}&{% endif %}{% if filter.outcome %}outcome={{ filter.outcome }}&{% endif %}{% if filter.start_date %}start_date={{ filter.start_date }}&{% endif %}{% if filter.end_date %}end_date={{ filter.end_date }}&{% endif %}{% if filter.sort %}sort={{ filter.sort }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-info text-white">Account Summaries</div>
        <form method="get" class="mb-2">
          <label for="base_currency">Base Currency:</label>
          <select name="base_currency" id="base_currency" class="form-select d-inline w-auto" onchange="this.form.submit()">
            {% for code, rate in conversion_rates.items %}
              <option value="{{ code }}" {% if base_currency == code %}selected{% endif %}>{{ code }}</option>
            {% endfor %}
          </select>
          {% for key, value in filter.items %}
            {% if value and key != 'base_currency' %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
          {% endfor %}
        </form>
        <div class="table-responsive">
          <table class="table table-bordered table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Balance</th>
                <th>Currency</th>
                <th>Total PnL</th>
                <th>Balance ({{ base_currency }})</th>
                <th>PnL ({{ base_currency }})</th>
              </tr>
            </thead>
            <tbody>
              {% for acc in account_summaries %}
              <tr>
                <td>{{ acc.name }}</td>
                <td>{{ acc.balance }}</td>
                <td>{{ acc.currency }}</td>
                <td>{{ acc.pnl|floatformat:2 }}</td>
                <td>{{ acc.converted_balance|floatformat:2 }}</td>
                <td>{{ acc.converted_pnl|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-warning text-dark">Analytics: Instrument Performance</div>
        <div class="table-responsive">
          <table class="table table-sm table-striped mb-0">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>Trades</th>
                <th>Win Rate (%)</th>
                <th>Total PnL</th>
              </tr>
            </thead>
            <tbody>
              {% for row in instrument_stats %}
              <tr>
                <td>{{ row.instrument }}</td>
                <td>{{ row.count }}</td>
                <td>{{ row.win_rate|floatformat:2 }}</td>
                <td>{{ row.pnl|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-secondary text-white">Analytics: Win Rate &amp; PnL by Outcome</div>
        <div class="table-responsive">
          <table class="table table-sm table-striped mb-0">
            <thead>
              <tr>
                <th>Outcome</th>
                <th>Trades</th>
                <th>Win Rate (%)</th>
                <th>Total PnL</th>
              </tr>
            </thead>
            <tbody>
              {% for row in outcome_stats %}
              <tr>
                <td>{{ row.outcome }}</td>
                <td>{{ row.count }}</td>
                <td>{{ row.win_rate|floatformat:2 }}</td>
                <td>{{ row.pnl|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">Recent Trade Attachments</div>
    <ul class="list-group list-group-flush">
      {% for trade in trades %}
        {% for attachment in trade.attachments.all %}
          <li class="list-group-item">
            <strong>{{ trade.instrument }} ({{ trade.entry_date|date:'Y-m-d' }})</strong>:
            <a href="{{ attachment.file.url }}" target="_blank">{{ attachment.file.name|slice:'15:' }}</a>
            <span class="text-muted">(uploaded {{ attachment.uploaded_at|date:'Y-m-d H:i' }})</span>
          </li>
        {% endfor %}
      {% endfor %}
      {% if not trades %}
        <li class="list-group-item">No attachments yet.</li>
      {% endif %}
    </ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ pnl_dates|json_script:"pnlDates" }}
{{ pnl_values|json_script:"pnlValues" }}
<script>
  const labels = JSON.parse(document.getElementById('pnlDates').textContent);
  const data = JSON.parse(document.getElementById('pnlValues').textContent);
  const ctx = document.getElementById('pnlChart').getContext('2d');
  const pnlChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'PnL Over Time',
        data: data,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        fill: true,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
</script>
{% endblock %}
